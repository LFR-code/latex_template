---
title: |
  A pragmatic approach for managing Fraser River Eulachon (*Thaleichthys pacificus*) fisheries: rapid prototyping operating model development and management procedure evaluation
recipient: |
  Someone1, 
  Someone2
author: |
  Beau Doherty,
  Samuel D N Johnson,
  Ashleen Benson, and
  Sean P Cox (author list and order TBD)
address: |
  Landmark Fisheries Research\
     211 - 2414 St Johns Street\
     Port Moody, British Columbia, V3H 2B1, Canada\
email: |
  Email: info@landmarkfisheries.com
month: "Month"
year: 2022
report_number: nnn
abstract: |
  Insert abstract text here.
date: \today
# link-citations: true
bibliography: bib/refs.bib
natbib: true
geometry: letterpaper
toc: false
fontsize: 12pt
lineno: true #line number
csl-refs: true
numbersections: true
noindent: true #if true: all paragraph will have no indentation, otherwise there will be indentation on 2nd paragraph

header: "Draft working paper --- Do not cite or circulate" # or "" to omit
output:
 bookdown::pdf_document2:
   keep_text: true
   fig_caption: true
   latex_engine: pdflatex
   template: templates/basic.latex #choose the template
# ------------
# End of options to set
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
  kable_format <- "latex"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
  kable_format <- "latex"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  #  cache = TRUE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
```

```{r load-libraries, echo = FALSE, cache = FALSE, message = FALSE, results = 'hide', warning = FALSE}
# add other packages here:
library(dplyr)
library(readr)
library(tibble)
library(kableExtra)
library(scales)
library(RColorBrewer)
library(csasdown)

```

<!--chapter:end:index.Rmd-->

# BACKGROUND

Insert text here.

## Subsection

Insert text here.

# CONSERVATION OBJECTIVES

The primary management objective for BC Eulachon aims to promote stock rebuilding to a level consistent with a COSEWIC categorization of ‘special concern’ [@Schweigert_2012; @dfo2023_eulIFMP]. This objective is interpreted as achieving positive growth in Eulachon spawning biomass in the short-term, and achieving historical levels of biomass over the long-term.

Formal conservation objectives for FR Eulachon that are consistent with the SFF and FSP policies [@dfo_2009a; @dfo_2022b] have not been defined, but at a minimum they require a choice of i) a limit reference point, ii) the removal reference (RR) rate (i.e., the maximum acceptable harvest rate), with desired probabilities for biomass being above the LRP and harvest rates below the RR over a specific timeframe.


<!--chapter:end:01-background.Rmd-->

# OPERATING MODEL

Insert text here.

## Subsection

### Smaller subsection
Reference tables like this: Model notation is given in Table \ref{tab:SISCALnotation} and 
population dynamics and statistical model equations in Tables 
\ref{tab:procObsModelEqns} and \ref{tab:statModelEqns}, respectively.

Reference figures like this: Figure \ref{fig:rnorm} and Figure \ref{fig:likProfM}.

<!--chapter:end:02-om.Rmd-->

# MANAGEMENT PROCEDURE EVALUATION
Insert text here

<!--chapter:end:03-mp.Rmd-->

# DISCUSSION

Insert text here.


<!--chapter:end:04-discussion.Rmd-->

<!-- Do not edit this file! -->

\clearpage

# REFERENCES {-}

<div id="refs"></div>

<!--chapter:end:06-references.Rmd-->

```{r capsAndEquations, include = FALSE}

procObsModelEqs <- read.csv("data/procModelEqns_EUL_hRicker.csv")
statModelEqs    <- read.csv("data/statModelEqns.csv")
# spModelEqs      <- read.csv("data/SSPMeqs.csv")

notationTableCap <- "Notation used in the specification of the SISCAL-EUL stock assessment model, along with a description of each variable, and possible fixed values."

procModelEqnTableCap  <- "Process and observation model equations for the SISCAL-EUL stock assessment model"

statModelEqnTableCap  <- "Statistical model prior and likelihood functions for the SISCAL-EUL stock assessment model. The function $\\textbf{1}(X)$ is the indicator function, taking value 1 when $X$ is true, and 0 when $X$ is false."

```
\clearpage

# TABLES

```{r SISCALnotation, echo = FALSE, message = FALSE, warnings = FALSE, eval = TRUE}
options(knitr.kable.NA = "")

notationTable <- tibble::tribble( 
    ~Symbol,           ~Value,           ~Description,
    "$T$",              "$53$",           "Total number of time steps 1965 - 2021",
    "$A$",              "$35$",           "Plus group age-class",
    "$L$",              "$32$",           "Number of length bins (4cm width)",
    "$t$",              "$1,2,\\dots,T$", "Time step",
    "$a$",              "$1,2,\\dots,A$", "Age-class index",
    "$l$",              "$2,6,\\dots,112$","Length-bin mid-points ($L = 32$ total length bins)",
    "$g$",              "$1,...,9$",      "Gear index as described in Table XX ($g=9$ only used in projections)", 
    "$x$",              "$1,2$",          "Sex index for males ($x=1$) and females ($x=2$)",
    "$B_{0}$",          NA,               "Unfished female spawning stock biomass",   
    "$h$",              NA,               "Ricker stock-recruitment steepness",
    "$R_{0}$",          NA,               "Unfished equilibrium age-1 recruitment",
    "$S_{a,x}$",        NA,               "Unfished equilibrium survivorship-at-age and sex",
    "$\\phi_{0}$",      NA,               "Unfished equilibrium spawning biomass per recruit",
    "$\\beta_1,\\beta_2$","$28.82, 10.55$","Beta prior parameters for steepness",
    "$\\omega_{t}$",    NA,               "Annual recruitment processs error log-deviations",
    "$\\sigma_{R}$",    "$1$",            "Standard error of $\\omega_{t}$ recruitment deviations",
    "$q_{g}$",          NA,               "Catchability coefficient for RV surveys ($g = 7,8,9$)",
    "$q_{t}$",          NA,               "Time-varying catchability coefficient for commercial CPUE index",
    "$M_{x,t}$",        NA,               "Time-varying natural mortality rate for males ($x = 1$) and females ($x=2$)",
    "$M_{0,x}$",        NA,               "Time-averaged natural mortality rate for males ($x = 1$) and females ($x=2$)",
    "$\\mu_M$",         "$0.14$",         "Natural mortality prior mean for males and females",
    "$\\sigma_M$",      "$0.05$",         "Natural mortality prior standard deviation for males and females",
    "$\\epsilon_{M,t}$",NA,               "Time-varying natural mortality random walk log-deviations",
    "$L_{\\infty,x}$",  "$68,72$",        "Asymptotic length (cm) for males ($x = 1$) and females ($x=2$)",
    "$\\sigma_{L,x}$",  "$0.08,0.11$",    "CV in length-at-age distribution",
    "$K_x$",            "$0.10,0.068$",   "von Bertalanffy growth constant for males and females",
    "$L_{1,x}$",        "$16.26,16.53$",  "Length-at-age 1 (same for males and females)",
    "$c_1,c_2$",        "$3.86e-6,3.22$", "Allometric length-weight transformation coefficients",
    "$l_{50},l_{95}$",  "$67,78$",        "Length-at-50\\% and -95\\% maturity",
    "$L_{a,x}$",        NA,               "Mean length-at-age (cm) for males and females",
    "$w_{a,x}$",        NA,               "Mean weight-at-age (cm) for males and females",
    "$m_l$",            NA,               "Proportion females mature-at-length",
    "$m_a$",            NA,               "Proportion females mature-at-age",
    "$s_{l,g}$",        NA,               "Mean selectivity-at-length $l$ for gear $g$",
    "$s_{a,x,g}$",      NA,               "Mean selectivity-at-age $a$ for gear $g$ and sex $x$",
    "$L_{50,g}^{A}$",   NA,               "Length-at-50\\% selectivity for ascending limb",
    "$L_{95,g}^{A}$",   NA,               "Length-at-95\\% selectivity for ascending limb",
    "$L_{50,g}^{D}$",   NA,               "Length-at-50\\% selectivity for descending limb",
    "$L_{95,g}^{D}$",   NA,               "Length-at-95\\% selectivity for descending limb",
    "$N_{a,x,t}$",      NA,               "Numbers-at-age $a$ for sex $x$ in year $t$",
    "$B_{t}$",          NA,               "Female spawning biomass in year $t$",
    "$C_{g,t}$",        NA,               "Observed total catch (biomass units) for gear $g$ in year $t$",
    "$C_{a,x,g,t}$",    NA,               "Expected catch-at-age (numbers) $a$ and sex $x$ by gear $g$ in year $t$",
    "$C'_{a,x,g,t}$",   NA,               "Expected catch-at-age (biomass units) $a$ and sex $x$ by gear $g$ in year $t$",
    "$B^{exp}_{t}$",    NA,               "Allocation weighted average exploitable biomass in year $t$",
    "$U_{g,t}$",        NA,               "Exploitation rate by gear $g$ in year $t$",
    "$U_{t}$",          NA,               "Total exploitation rate in year $t$",
    "$I_{g,t}$",        NA,               "Observed biomass/abundance index for gear $g \\in \\{7,8\\}$ in year $t$",
    "$\\hat{I}_{g,t}$", NA,               "Expected biomass/abundance index for gear $g \\in \\{7,8\\}$ in year $t$",
    "$\\tau_{g}$",      NA,               "Standard deviation of biomass index observation log-residuals",
    "$u_{l,x,g,t}$",      NA,             "Observed length composition data for sex $x$ in gear $g$ at time $t$",
    "$\\hat{u}_{l,x,g,t}$",NA,            "Expected length composition data for sex $x$ in gear $g$ at time $t$",
    "$\\hat{\\tau}^{len}_{x,g}$",NA,      "Conditional MLE of length composition sampling error, by sex and gear",
)


csasdown::csas_table( notationTable  , escape = FALSE,
                      booktabs = TRUE, font_size = 10,
                      format = kable_format,
                      linesep = "\\addlinespace[5pt]",
                      caption = notationTableCap,
                      align = c("c","c","l") ) |>
  kable_styling(  latex_options = c("hold_position", "scale_down"),
                  bootstrap_options = c("striped", "hover","scale_down"),
                  font_size = 10)

```

\clearpage



```{r procObsModelEqns, echo = FALSE, message = FALSE, warnings = FALSE, eval = TRUE }

colnames(procObsModelEqs) <- c("No.", "Equation")


kable( procObsModelEqs, 
        format = kable_format,
        escape = FALSE,
        linesep = "\\addlinespace[5pt]",
        booktabs = TRUE,
        caption = procModelEqnTableCap,
        longtable = TRUE,
        align = c("c","l")) |>
  kable_styling(latex_options = c("hold_position",
                                  "scale_down"),
                bootstrap_options = c("striped", "hover"),
                font_size = 10) |>
  kableExtra::pack_rows("Model Parameters", 1, 4 ) |>
  kableExtra::pack_rows("Growth and maturity", 5, 10 ) |>
  kableExtra::pack_rows("Selectivity", 11, 12 ) |>
  kableExtra::pack_rows("Unfished equilibrium states", 14, 17 ) |>
  kableExtra::pack_rows("Fishery removals", 18, 25 ) |>
  kableExtra::pack_rows("Spawning biomass, recruitment, and numbers-at-age", 26, 28 )
  

```

\clearpage

```{r statModelEqns, echo = FALSE, message = FALSE, warnings = FALSE, eval = TRUE }

colnames(statModelEqs) <- c("No.", "Equation")

kable( statModelEqs, escape = FALSE,
        booktabs = TRUE,
        format = kable_format,
        linesep = "\\addlinespace[5pt]",
        caption = statModelEqnTableCap,
        longtable = TRUE,
        align = c("c","l")) |>
  kable_styling(latex_options = c("hold_position","scale_down"),
                bootstrap_options = c("hover"),
                font_size = 10)  |>
  kableExtra::group_rows("Observation models for biomass index and composition data", 1, 2 ) |>
  kableExtra::group_rows("Biomass index likelihood", 3, 7 ) |>
  kableExtra::group_rows("Length composition likelihood", 8, 12 ) |>
  kableExtra::group_rows("Model priors", 13, 16 ) |>
  kableExtra::group_rows("Objective Function", 17, 17 )
  # kableExtra::group_rows("Observation models for biomass index and composition data", 1, 3 ) |>
  # kableExtra::group_rows("Biomass index likelihood", 4, 8 ) |>
  # kableExtra::group_rows("Length composition likelihood", 9, 13 ) |>
  # kableExtra::group_rows("Model priors", 14, 17 ) |>
  # kableExtra::group_rows("Objective Function", 18, 18 )

```

\clearpage

<!--chapter:end:07-tables.Rmd-->

# FIGURES

You can add figure from code block or from image files:

```{r figcaptions, include = FALSE, echo = FALSE}

likProfMCap <- "Negative log likelihood (NLL) profile for operating model fits with natural mortaltiy fixed at values ranging from 0.1 to 1.0. The top panel shows the total NLL, while the middle and bottom panels show NLL components for indices and length compositions, respectively."

rnormhist <- "histogram of 1000 draws from normal distribution"
```

```{r rnorm, echo = FALSE, fig.cap = rnormhist, eval = TRUE, fig.width = 8, fig.asp = 1.2, out.width = "6in" }
x <- rnorm(1000)
hist(x)
```
\clearpage
```{r likProfM, fig.cap=likProfMCap, echo = FALSE, message=FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics("figure/LikeProfileM.pdf")
```

\clearpage

<!--chapter:end:08-figures.Rmd-->

# (APPENDIX) Appendix {-}
<!-- \renewcommand\thefigure{\thesection.\arabic{figure}} -->
<!-- \setcounter{figure}{0} -->
<!-- \renewcommand\thetable{\thesection.\arabic{table}} -->
<!-- \setcounter{table}{0} -->
\counterwithin{figure}{section}
\counterwithin{table}{section}
<!-- Do not delete/edit the lines above -->
# Appendix A

## Subsection

Insert text here.
```{r figure names1}
wcviTowsFig <-  "Number of SMMS tows in WCVI PFMAs from 1975-2021"
```

```{r wcviTowsFig1, fig.cap=wcviTowsFig, echo = FALSE, message=FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics("figure/wcviTowsByPFMA.pdf")
```

\clearpage

```{r table}
kable(head(iris),
      format = kable_format,
      escape = FALSE,
      booktabs = TRUE,
      caption = "Iris data",
      align = c("c","l")) %>% 
  kable_styling(latex_options = c("hold_position","scale_down"),
                bootstrap_options = c("striped", "hover"),
                font_size = 10)

```

# Appendix B

Insert text here

## Subsection

### Smaller subsection

Insert text

You can also include figures in the appendix (Figure \ref{fig:wcviTowsFig}).

\clearpage

## Figures

```{r figure names}
wcviTowsFig <-  "Number of SMMS tows in WCVI PFMAs from 1975-2021"
```

```{r wcviTowsFig, fig.cap=wcviTowsFig, echo = FALSE, message=FALSE, fig.align = "center", out.width = "100%"}
knitr::include_graphics("figure/wcviTowsByPFMA.pdf")
```

<!--chapter:end:09-appendix.Rmd-->

